open! Core
open! Hardcaml
open Hardcaml_waveterm
module Ram_with_resizing = Hardcaml_xilinx.Ram_with_resizing

let ( <-. ) a b = a := Bits.of_int ~width:(Bits.width !a) b

let test ?(read_latency = 1) log_scale_between_ports =
  let bits_per_word = 4 in
  let log_num_words = 3 in
  let module Ram =
    Ram_with_resizing.Make (struct
      let bits_per_word = bits_per_word
      let log_scale_between_ports = log_scale_between_ports
      let log_num_words = log_num_words
      let read_latency = read_latency
    end)
  in
  print_s
    [%message
      (Ram.write_address_bits : int)
        (Ram.read_address_bits : int)
        (Ram.write_data_bits : int)
        (Ram.read_data_bits : int)];
  let module Sim = Cyclesim.With_interface (Ram.I) (Ram.O) in
  let sim =
    Sim.create (Ram.create ~build_mode:Simulation (Scope.create ~flatten_design:true ()))
  in
  let waves, sim = Waveform.create sim in
  let inputs = Cyclesim.inputs sim in
  (* write *)
  let scale_up =
    1 lsl if log_scale_between_ports >= 0 then 0 else -log_scale_between_ports
  in
  print_s [%message (scale_up : int)];
  inputs.write_enable <-. 1;
  for i = 0 to ((1 lsl log_num_words) / scale_up) - 1 do
    inputs.write_address <-. i;
    inputs.write_data <-. 0x4321 + (i * 0x11111111 * scale_up);
    Cyclesim.cycle sim
  done;
  inputs.write_enable <-. 0;
  (* read *)
  let scale_up =
    1 lsl if log_scale_between_ports <= 0 then 0 else log_scale_between_ports
  in
  inputs.read_enable <-. 1;
  for i = 0 to ((1 lsl log_num_words) / scale_up) - 1 do
    inputs.read_address <-. i;
    Cyclesim.cycle sim
  done;
  inputs.read_enable <-. 0;
  for _ = 0 to read_latency do
    Cyclesim.cycle sim
  done;
  Waveform.expect ~display_width:90 ~display_height:22 ~wave_width:1 waves
;;

let%expect_test "no scale" =
  test 0;
  [%expect
    {|
((Ram.write_address_bits 3) (Ram.read_address_bits 3) (Ram.write_data_bits 4)
 (Ram.read_data_bits 4))
(scale_up 1)
┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
│clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
│                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
│                  ││────────────────────────────────────┬───┬───┬───┬───┬───┬───┬───────│
│read_address      ││ 0                                  │1  │2  │3  │4  │5  │6  │7      │
│                  ││────────────────────────────────────┴───┴───┴───┴───┴───┴───┴───────│
│read_enable       ││                                ┌───────────────────────────────┐   │
│                  ││────────────────────────────────┘                               └───│
│                  ││────┬───┬───┬───┬───┬───┬───┬───────────────────────────────────────│
│write_address     ││ 0  │1  │2  │3  │4  │5  │6  │7                                      │
│                  ││────┴───┴───┴───┴───┴───┴───┴───────────────────────────────────────│
│                  ││────┬───┬───┬───┬───┬───┬───┬───────────────────────────────────────│
│write_data        ││ 1  │2  │3  │4  │5  │6  │7  │8                                      │
│                  ││────┴───┴───┴───┴───┴───┴───┴───────────────────────────────────────│
│write_enable      ││────────────────────────────────┐                                   │
│                  ││                                └───────────────────────────────────│
│                  ││────────────────────────────────────┬───┬───┬───┬───┬───┬───┬───┬───│
│q                 ││ 0                                  │1  │2  │3  │4  │5  │6  │7  │8  │
│                  ││────────────────────────────────────┴───┴───┴───┴───┴───┴───┴───┴───│
│                  ││                                                                    │
│                  ││                                                                    │
└──────────────────┘└────────────────────────────────────────────────────────────────────┘
84553838962977b14b84bebd9258c2fa |}]
;;

let%expect_test "write port wider x2" =
  test (-1);
  [%expect
    {|
((Ram.write_address_bits 2) (Ram.read_address_bits 3) (Ram.write_data_bits 8)
 (Ram.read_data_bits 4))
(scale_up 2)
┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
│clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
│                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
│clear             ││                                                                    │
│                  ││────────────────────────────────────────────────────────            │
│                  ││────────────────────┬───┬───┬───┬───┬───┬───┬───────────            │
│read_address      ││ 0                  │1  │2  │3  │4  │5  │6  │7                      │
│                  ││────────────────────┴───┴───┴───┴───┴───┴───┴───────────            │
│read_enable       ││                ┌───────────────────────────────┐                   │
│                  ││────────────────┘                               └───────            │
│                  ││────┬───┬───┬───────────────────────────────────────────            │
│write_address     ││ 0  │1  │2  │3                                                      │
│                  ││────┴───┴───┴───────────────────────────────────────────            │
│                  ││────┬───┬───┬───────────────────────────────────────────            │
│write_data        ││ 21 │43 │65 │87                                                     │
│                  ││────┴───┴───┴───────────────────────────────────────────            │
│write_enable      ││────────────────┐                                                   │
│                  ││                └───────────────────────────────────────            │
│                  ││────────────────────┬───┬───┬───┬───┬───┬───┬───┬───────            │
│q                 ││ 0                  │1  │2  │3  │4  │5  │6  │7  │8                  │
│                  ││────────────────────┴───┴───┴───┴───┴───┴───┴───┴───────            │
└──────────────────┘└────────────────────────────────────────────────────────────────────┘
69674b1ec7a08adcbf409a93d31559aa |}]
;;

let%expect_test "write port wider x4" =
  test (-2);
  [%expect
    {|
    ((Ram.write_address_bits 1) (Ram.read_address_bits 3)
     (Ram.write_data_bits 16) (Ram.read_data_bits 4))
    (scale_up 4)
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │clear             ││                                                                    │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────┬───┬───┬───┬───┬───┬───┬───────────                    │
    │read_address      ││ 0          │1  │2  │3  │4  │5  │6  │7                              │
    │                  ││────────────┴───┴───┴───┴───┴───┴───┴───────────                    │
    │read_enable       ││        ┌───────────────────────────────┐                           │
    │                  ││────────┘                               └───────                    │
    │write_address     ││    ┌───────────────────────────────────────────                    │
    │                  ││────┘                                                               │
    │                  ││────┬───────────────────────────────────────────                    │
    │write_data        ││ 43.│8765                                                           │
    │                  ││────┴───────────────────────────────────────────                    │
    │write_enable      ││────────┐                                                           │
    │                  ││        └───────────────────────────────────────                    │
    │                  ││────────────┬───┬───┬───┬───┬───┬───┬───┬───────                    │
    │q                 ││ 0          │1  │2  │3  │4  │5  │6  │7  │8                          │
    │                  ││────────────┴───┴───┴───┴───┴───┴───┴───┴───────                    │
    │                  ││                                                                    │
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘
    2e01476e50dc38e7f1244fa02315818d |}]
;;

let%expect_test "write port wider x8 - raises" =
  Expect_test_helpers_base.require_does_raise [%here] (fun () -> test (-3));
  [%expect
    {|
    ("Cannot construct RAM with < 2 write entries"
     (write_address_bits 0)
     (read_address_bits  3)
     (write_data_bits    32)
     (read_data_bits     4)) |}]
;;

let%expect_test "read port wider x2" =
  test 1;
  [%expect
    {|
((Ram.write_address_bits 3) (Ram.read_address_bits 2) (Ram.write_data_bits 4)
 (Ram.read_data_bits 8))
(scale_up 1)
┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
│clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
│                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
│                  ││────────────────────────────────────┬───┬───┬───────────            │
│read_address      ││ 0                                  │1  │2  │3                      │
│                  ││────────────────────────────────────┴───┴───┴───────────            │
│read_enable       ││                                ┌───────────────┐                   │
│                  ││────────────────────────────────┘               └───────            │
│                  ││────┬───┬───┬───┬───┬───┬───┬───────────────────────────            │
│write_address     ││ 0  │1  │2  │3  │4  │5  │6  │7                                      │
│                  ││────┴───┴───┴───┴───┴───┴───┴───────────────────────────            │
│                  ││────┬───┬───┬───┬───┬───┬───┬───────────────────────────            │
│write_data        ││ 1  │2  │3  │4  │5  │6  │7  │8                                      │
│                  ││────┴───┴───┴───┴───┴───┴───┴───────────────────────────            │
│write_enable      ││────────────────────────────────┐                                   │
│                  ││                                └───────────────────────            │
│                  ││────────────────────────────────────┬───┬───┬───┬───────            │
│q                 ││ 00                                 │21 │43 │65 │87                 │
│                  ││────────────────────────────────────┴───┴───┴───┴───────            │
│                  ││                                                                    │
│                  ││                                                                    │
└──────────────────┘└────────────────────────────────────────────────────────────────────┘
ef5b1716c1a6241d58c15cd2cc3768f4 |}]
;;

let%expect_test "read port wider x4" =
  test 2;
  [%expect
    {|
    ((Ram.write_address_bits 3) (Ram.read_address_bits 1) (Ram.write_data_bits 4)
     (Ram.read_data_bits 16))
    (scale_up 1)
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │read_address      ││                                    ┌───────────                    │
    │                  ││────────────────────────────────────┘                               │
    │read_enable       ││                                ┌───────┐                           │
    │                  ││────────────────────────────────┘       └───────                    │
    │                  ││────┬───┬───┬───┬───┬───┬───┬───────────────────                    │
    │write_address     ││ 0  │1  │2  │3  │4  │5  │6  │7                                      │
    │                  ││────┴───┴───┴───┴───┴───┴───┴───────────────────                    │
    │                  ││────┬───┬───┬───┬───┬───┬───┬───────────────────                    │
    │write_data        ││ 1  │2  │3  │4  │5  │6  │7  │8                                      │
    │                  ││────┴───┴───┴───┴───┴───┴───┴───────────────────                    │
    │write_enable      ││────────────────────────────────┐                                   │
    │                  ││                                └───────────────                    │
    │                  ││────────────────────────────────────┬───┬───────                    │
    │q                 ││ 0000                               │43.│8765                       │
    │                  ││────────────────────────────────────┴───┴───────                    │
    │                  ││                                                                    │
    │                  ││                                                                    │
    │                  ││                                                                    │
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘
    196bc610bf41bf3d5312d7b47793912d |}]
;;

let%expect_test "read port wider x4, read_latency=2" =
  test ~read_latency:2 2;
  [%expect
    {|
    ((Ram.write_address_bits 3) (Ram.read_address_bits 1) (Ram.write_data_bits 4)
     (Ram.read_data_bits 16))
    (scale_up 1)
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │clear             ││                                                                    │
    │                  ││────────────────────────────────────────────────────                │
    │read_address      ││                                    ┌───────────────                │
    │                  ││────────────────────────────────────┘                               │
    │read_enable       ││                                ┌───────┐                           │
    │                  ││────────────────────────────────┘       └───────────                │
    │                  ││────┬───┬───┬───┬───┬───┬───┬───────────────────────                │
    │write_address     ││ 0  │1  │2  │3  │4  │5  │6  │7                                      │
    │                  ││────┴───┴───┴───┴───┴───┴───┴───────────────────────                │
    │                  ││────┬───┬───┬───┬───┬───┬───┬───────────────────────                │
    │write_data        ││ 1  │2  │3  │4  │5  │6  │7  │8                                      │
    │                  ││────┴───┴───┴───┴───┴───┴───┴───────────────────────                │
    │write_enable      ││────────────────────────────────┐                                   │
    │                  ││                                └───────────────────                │
    │                  ││────────────────────────────────────────┬───┬───────                │
    │q                 ││ 0000                                   │43.│8765                   │
    │                  ││────────────────────────────────────────┴───┴───────                │
    │                  ││                                                                    │
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘
    fa3bdc9586abba1234097b4216989deb |}]
;;

let%expect_test "read port wider x8 - raises" =
  Expect_test_helpers_base.require_does_raise [%here] (fun () -> test 3);
  [%expect
    {|
    ("Cannot construct RAM with < 2 read entries"
     (write_address_bits 3)
     (read_address_bits  0)
     (write_data_bits    4)
     (read_data_bits     32)) |}]
;;
